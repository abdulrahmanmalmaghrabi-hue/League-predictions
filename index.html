<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#4CAF50" />
  <title>Premier League Predictions</title>
  
  <!-- ğŸ¨ ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent }
    
    body { 
      font-family: 'Segoe UI', Tahoma, sans-serif; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      padding: 10px; 
      margin: 0;
      min-height: 100vh;
      color: #333;
    }
    
    h1 { 
      color: white; 
      text-align: center; 
      font-size: 1.5rem;
      margin: 10px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .box { 
      background: rgba(255,255,255,0.95); 
      padding: 15px; 
      border-radius: 15px; 
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }
    
    h2 { 
      margin-top: 0;
      color: #2a5298;
      font-size: 1.2rem;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    input, button, select { 
      padding: 12px; 
      margin: 8px 0; 
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 5px rgba(76,175,80,0.3);
    }
    
    button { 
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    button:active { transform: scale(0.98) }
    
    .btn-primary { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none }
    .btn-danger { background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none }
    .btn-warning { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none }
    .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none }
    
    .match-row { 
      display: flex; 
      gap: 8px; 
      margin: 8px 0; 
      align-items: center;
      background: #f5f5f5;
      padding: 8px;
      border-radius: 8px;
    }
    
    .match-row input { 
      width: 35%; 
      text-align: center;
      font-weight: bold;
    }
    
    .match-row label { 
      width: 30%; 
      text-align: center; 
      font-weight: bold;
      color: #2a5298;
    }
    
    .leaderboard { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px;
      font-size: 14px;
    }
    
    .leaderboard th, .leaderboard td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center 
    }
    
    .leaderboard th { 
      background: linear-gradient(135deg, #4CAF50, #45a049); 
      color: white;
      position: sticky;
      top: 0;
    }
    
    .leaderboard tr:nth-child(even) { background: #f9f9f9 }
    .leaderboard tr:hover { background: #e3f2fd }
    
    .rank-1 { background: gold !important; font-weight: bold }
    .rank-2 { background: silver !important; font-weight: bold }
    .rank-3 { background: #cd7f32 !important; font-weight: bold; color: white }
    
    #adminPanel { 
      background: linear-gradient(135deg, #fff3e0, #ffe0b2); 
      border: 2px solid #ff9800 
    }
    
    .admin-section { 
      margin: 15px 0; 
      padding: 15px; 
      border: 1px solid #ddd; 
      border-radius: 10px;
      background: white;
    }
    
    .hidden { display: none !important }
    
    #loading { 
      text-align: center; 
      padding: 40px; 
      color: white;
      font-size: 1.2rem;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-admin { background: #ff9800; color: white }
    .badge-user { background: #4CAF50; color: white }
    
    /* âš¡ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ */
    .lazy-load { opacity: 0; transition: opacity 0.3s }
    .lazy-load.loaded { opacity: 1 }
    
    /* ğŸ” Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© */
    .secure-input {
      -webkit-text-security: disc;
      text-security: disc;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 400px) {
      body { padding: 5px }
      .box { padding: 10px }
      h1 { font-size: 1.2rem }
    }
  </style>
</head>
<body>

<!-- â³ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loading">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</p>
</div>

<h1>âš½ Premier League Predictions</h1>

<!-- âœ… ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box hidden" id="loginPage">
  <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" type="email" autocomplete="off">
  <input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password" class="secure-input">
  <button class="btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p id="userInfo"></p>
  <span id="adminBadge" class="badge badge-admin hidden">ğŸ‘‘ Ù…Ø´Ø±Ù</span>
</div>

<!-- âœ… Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminPanel" class="box hidden">
  <div style="display:flex; justify-content:space-between; align-items:center">
    <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <button class="btn-danger" onclick="logout()" style="width:auto; padding:8px 16px">Ø®Ø±ÙˆØ¬</button>
  </div>
  
  <!-- 1ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø±ÙŠØ§Øª -->
  <div class="admin-section">
    <h3>âš½ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
    <input id="matchRound" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">
    <input id="matchName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ø§ØªØ­Ø§Ø¯ vs Ø§Ù„Ù‡Ù„Ø§Ù„)">
    <input id="matchTime" type="datetime-local">
    <button class="btn-info" onclick="addMatch()">â• Ø¥Ø¶Ø§ÙØ©</button>
    <div id="matchesList" style="margin-top:10px; max-height:200px; overflow-y:auto"></div>
  </div>
  
  <!-- 2ï¸âƒ£ ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù -->
  <div class="admin-section">
    <h3>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</h3>
    <input id="editRoundId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: round_25)">
    <input id="editRoundName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <div style="display:flex; gap:10px">
      <button class="btn-warning" onclick="editRound()" style="flex:1">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn-danger" onclick="deleteRound()" style="flex:1">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
  </div>
  
  <!-- 3ï¸âƒ£ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="admin-section">
    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <input id="userEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <select id="userRole">
      <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
      <option value="admin">Ù…Ø´Ø±Ù</option>
    </select>
    <div style="display:flex; gap:10px">
      <button class="btn-info" onclick="addUser()" style="flex:1">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn-danger" onclick="removeUser()" style="flex:1">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
    <div id="usersList" style="margin-top:10px; max-height:150px; overflow-y:auto"></div>
  </div>
  
  <!-- 4ï¸âƒ£ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
  <div class="admin-section">
    <h3>ğŸ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
    <input id="adminRound" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">
    <div id="adminMatchesContainer"></div>
    <button class="btn-warning" onclick="postResults()">Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ + Ù‚ÙÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
  </div>
</div>

<!-- âœ… ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="userPanel" class="box hidden">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2 style="margin:0">ğŸ‘¤ ØªÙˆÙ‚Ø¹Ø§ØªÙŠ</h2>
    <div>
      <span class="badge badge-user">Ù…Ø³ØªØ®Ø¯Ù…</span>
      <button class="btn-danger" onclick="logout()" style="width:auto; padding:6px 12px; font-size:12px">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  
  <input id="roundNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">
  
  <div style="margin:15px 0; padding:10px; background:#e3f2fd; border-radius:8px">
    <label><strong>ğŸ¯ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</strong></label>
    <select id="doubleMatch">
      <option value="0">Ø¨Ø¯ÙˆÙ† Ù…Ø¶Ø§Ø¹ÙØ©</option>
      ${[1,2,3,4,5,6,7,8,9,10].map(i => `<option value="${i}">Ù…Ø¨Ø§Ø±Ø§Ø© ${i}</option>`).join('')}
    </select>
    <small style="color:#666; display:block; margin-top:5px">Ø§Ø®ØªØ± Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¶Ø¹Ù Ø§Ù„Ù†Ù‚Ø§Ø· (6 Ù†Ù‚Ø§Ø·)</small>
  </div>
  
  <div id="matchesContainer"></div>
  <button class="btn-primary" onclick="submitUserPrediction()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹</button>
</div>

<!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† -->
<div class="box">
  <h2>ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
  <button class="btn-info" onclick="loadLeaderboard()" style="margin-bottom:10px">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <div id="leaderboardContainer" style="max-height:400px; overflow-y:auto"></div>
</div>

<!-- ğŸ” Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© -->
<script>
  // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù†
  document.addEventListener('contextmenu', e => e.preventDefault());
  
  // Ù…Ù†Ø¹ F12 Ùˆ DevTools
  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key))) {
      e.preventDefault();
    }
  });
  
  // ÙƒØ´Ù DevTools
  setInterval(() => {
    const threshold = 160;
    if (window.outerWidth - window.innerWidth > threshold || 
        window.outerHeight - window.innerHeight > threshold) {
      document.body.innerHTML = '<h1 style="text-align:center; color:red; padding:50px">ğŸš« Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­</h1>';
    }
  }, 1000);
</script>

<script type="module">
  // ============================================
  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
  // ============================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
    collection, addDoc, getDocs, writeBatch, increment, 
    query, orderBy, limit, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ============================================
  // âš¡ ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
  // ============================================
  const firebaseConfig = {
    apiKey: "AIzaSyAQw9E_LtJ5QQDGpkGV6n9-re3CD7DLvbk",
    authDomain: "englishleagueapp-6337c.firebaseapp.com",
    projectId: "englishleagueapp-6337c",
    storageBucket: "englishleagueapp-6337c.firebasestorage.app",
    messagingSenderId: "441958380116",
    appId: "1:441958380116:web:741712fe2ca9471e81f3c1",
    measurementId: "G-ETQNFJQBN2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // âš¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø£Ø¯Ø§Ø¡
  try {
    await setPersistence(auth, browserLocalPersistence);
    await enableIndexedDbPersistence(db);
  } catch (e) {
    console.log("Persistence not enabled:", e);
  }

  // ============================================
  // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
  // ============================================
  let currentUser = null;
  let isAdmin = false;
  let appReady = false;

  // ============================================
  // Ø¯Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  // ============================================
  function authStateReady() {
    return new Promise((resolve) => {
      const unsubscribe = onAuthStateChanged(auth, (user) => {
        unsubscribe();
        resolve(user);
      });
    });
  }

  // ============================================
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
  // ============================================
  async function checkIfAdmin(uid) {
    try {
      const adminSnap = await getDoc(doc(db, "admins", uid));
      return adminSnap.exists() && adminSnap.data().role === "admin";
    } catch (error) {
      console.error("Error:", error);
      return false;
    }
  }

  // ============================================
  // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
  // ============================================
  const show = (id) => document.getElementById(id).classList.remove("hidden");
  const hide = (id) => document.getElementById(id).classList.add("hidden");

  // ============================================
  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
  // ============================================
  function createMatchInputs(containerId, prefix) {
    const container = document.getElementById(containerId);
    for (let i = 1; i <= 10; i++) {
      container.innerHTML += `
        <div class="match-row">
          <label>Ù…${i}</label>
          <input id="${prefix}${i}h" placeholder="0" type="number" min="0" max="20">
          <input id="${prefix}${i}a" placeholder="0" type="number" min="0" max="20">
        </div>
      `;
    }
  }

  createMatchInputs('matchesContainer', 'm');
  createMatchInputs('adminMatchesContainer', 'a');

  // ============================================
  // âš¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  // ============================================
  async function initApp() {
    show("loading");
    hide("loginPage");
    hide("adminPanel");
    hide("userPanel");

    try {
      const user = await authStateReady();
      
      if (user) {
        currentUser = user;
        isAdmin = await checkIfAdmin(user.uid);
      } else {
        currentUser = null;
        isAdmin = false;
      }

      hide("loading");

      if (isAdmin) {
        show("adminPanel");
        document.getElementById("adminBadge").classList.remove("hidden");
        await loadMatches();
        await loadUsers();
      } else if (currentUser) {
        show("userPanel");
        document.getElementById("adminBadge").classList.add("hidden");
      } else {
        show("loginPage");
        document.getElementById("userInfo").innerText = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
      }

      await loadLeaderboard();
      appReady = true;
      
    } catch (error) {
      console.error("Error:", error);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
    }
  }

  // ============================================
  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  // ============================================
  window.login = async () => {
    try {
      await signInWithEmailAndPassword(auth, email.value, password.value);
      await initApp();
    } catch (e) {
      alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
    }
  };

  window.logout = async () => {
    await signOut(auth);
    location.reload();
  };

  // ============================================
  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†
  // ============================================
  window.addMatch = async () => {
    if (!isAdmin) return;
    await addDoc(collection(db, "matches"), {
      round: matchRound.value,
      name: matchName.value,
      time: matchTime.value,
      created_at: new Date().toISOString()
    });
    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    await loadMatches();
  };

  window.editRound = async () => {
    if (!isAdmin) return;
    await updateDoc(doc(db, "rounds", editRoundId.value), { name: editRoundName.value });
    alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
  };

  window.deleteRound = async () => {
    if (!isAdmin) return;
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    await deleteDoc(doc(db, "rounds", editRoundId.value));
    alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
  };

  window.addUser = async () => {
    if (!isAdmin) return;
    await setDoc(doc(db, "admins", userEmail.value), {
      email: userEmail.value,
      role: userRole.value
    });
    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    await loadUsers();
  };

  window.removeUser = async () => {
    if (!isAdmin) return;
    await deleteDoc(doc(db, "admins", userEmail.value));
    alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
    await loadUsers();
  };

  // ============================================
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  // ============================================
  async function loadMatches() {
    const snapshot = await getDocs(collection(db, "matches"));
    let html = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      html += `<div style="padding:8px; border-bottom:1px solid #eee">${d.name} - ${d.round}</div>`;
    });
    document.getElementById("matchesList").innerHTML = html || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª';
  }

  async function loadUsers() {
    const snapshot = await getDocs(collection(db, "admins"));
    let html = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      html += `<div style="padding:8px; border-bottom:1px solid #eee">${d.email} - ${d.role}</div>`;
    });
    document.getElementById("usersList").innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†';
  }

  // ============================================
  // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
  // ============================================
  window.postResults = async () => {
    if (!isAdmin) return;

    const round = "round_" + adminRound.value;
    const actualResult = {};
    
    for (let i = 1; i <= 10; i++) {
      actualResult[`match_${i}_home`] = Number(document.getElementById(`a${i}h`).value) || 0;
      actualResult[`match_${i}_away`] = Number(document.getElementById(`a${i}a`).value) || 0;
    }

    await setDoc(doc(db, "actual_results", round), actualResult, { merge: true });
    await setDoc(doc(db, "rounds", round), { is_locked: true }, { merge: true });

    const preds = await getDocs(collection(db, "predictions", round, "users"));
    const batch = writeBatch(db);

    preds.forEach(p => {
      const d = p.data();
      let pts = 0;

      for (let i = 1; i <= 10; i++) {
        if (d[`match_${i}_home`] === actualResult[`match_${i}_home`] &&
            d[`match_${i}_away`] === actualResult[`match_${i}_away`]) {
          pts += 3;
          if (d.double_match === i) pts += 3;
        }
      }

      batch.update(p.ref, { total_points: pts });
      batch.set(doc(db, "leaderboard", p.id), {
        participant_name: d.participant_name,
        total_points: increment(pts)
      }, { merge: true });
    });

    await batch.commit();
    alert("ğŸ† ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·!");
    await loadLeaderboard();
  };

  // ============================================
  // Ø¥Ø±Ø³Ø§Ù„ ØªÙˆÙ‚Ø¹
  // ============================================
  window.submitUserPrediction = async () => {
    if (isAdmin) return alert("Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§ ÙŠØ±Ø³Ù„ ØªÙˆÙ‚Ø¹Ø§Øª!");
    if (!currentUser) return alert("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§");

    const round = "round_" + roundNumber.value;
    const roundDoc = await getDoc(doc(db, "rounds", round));
    if (roundDoc.exists() && roundDoc.data().is_locked) {
      return alert("âŒ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù…Ù‚ÙÙ„Ø©!");
    }

    const prediction = {
      participant_name: currentUser.email,
      total_points: 0,
      double_match: Number(doubleMatch.value),
      timestamp: new Date().toISOString()
    };

    for (let i = 1; i <= 10; i++) {
      prediction[`match_${i}_home`] = Number(document.getElementById(`m${i}h`).value) || 0;
      prediction[`match_${i}_away`] = Number(document.getElementById(`m${i}a`).value) || 0;
    }

    await setDoc(doc(db, "predictions", round, "users", currentUser.uid), prediction, { merge: true });
    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  };

  // ============================================
  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
  // ============================================
  window.loadLeaderboard = async () => {
    const q = query(collection(db, "leaderboard"), orderBy("total_points", "desc"), limit(20));
    const snapshot = await getDocs(q);
    
    let html = `<table class="leaderboard">
      <tr><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>`;
    
    let rank = 1;
    snapshot.forEach(doc => {
      const d = doc.data();
      const rankClass = rank <= 3 ? `rank-${rank}` : '';
      html += `<tr class="${rankClass}">
        <td>${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank}</td>
        <td>${d.participant_name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td>
        <td>${d.total_points || 0}</td>
      </tr>`;
      rank++;
    });
    
    html += '</table>';
    document.getElementById("leaderboardContainer").innerHTML = html;
  };

  // ============================================
  // ØªØ´ØºÙŠÙ„
  // ============================================
  document.addEventListener("DOMContentLoaded", initApp);
</script>

</body>
</html>