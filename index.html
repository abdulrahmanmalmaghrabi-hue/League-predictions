<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#4CAF50" />
  <title>Premier League Predictions</title>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 10px; margin: 0; min-height: 100vh; color: #333; }
    h1 { color: white; text-align: center; font-size: 1.5rem; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .box { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
    h2 { margin-top: 0; color: #2a5298; font-size: 1.2rem; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    input, button, select { padding: 12px; margin: 8px 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
    input:focus, select:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 5px rgba(76,175,80,0.3); }
    button { cursor: pointer; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    button:active { transform: scale(0.98) }
    .btn-primary { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none }
    .btn-danger { background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none }
    .btn-warning { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none }
    .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none }
    .match-row { display: flex; gap: 8px; margin: 8px 0; align-items: center; background: #f5f5f5; padding: 8px; border-radius: 8px; }
    .match-row input { width: 35%; text-align: center; font-weight: bold; }
    .match-row label { width: 30%; text-align: center; font-weight: bold; color: #2a5298; }
    .leaderboard { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .leaderboard th, .leaderboard td { border: 1px solid #ddd; padding: 10px; text-align: center }
    .leaderboard th { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; position: sticky; top: 0; }
    .leaderboard tr:nth-child(even) { background: #f9f9f9 } .leaderboard tr:hover { background: #e3f2fd }
    .rank-1 { background: gold !important; font-weight: bold } .rank-2 { background: silver !important; font-weight: bold } .rank-3 { background: #cd7f32 !important; font-weight: bold; color: white }
    #adminPanel { background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 2px solid #ff9800 }
    .admin-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 10px; background: white; }
    .hidden { display: none !important }
    #loading { text-align: center; padding: 40px; color: white; font-size: 1.2rem; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .badge-admin { background: #ff9800; color: white } .badge-user { background: #4CAF50; color: white }
    .lazy-load { opacity: 0; transition: opacity 0.3s } .lazy-load.loaded { opacity: 1 }
    .secure-input { -webkit-text-security: disc; text-security: disc; }
    @media (max-width: 400px) { body { padding: 5px } .box { padding: 10px } h1 { font-size: 1.2rem } }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</p>
</div>

<h1>âš½ Premier League Predictions</h1>

<div class="box hidden" id="loginPage">
  <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" type="email" autocomplete="off">
  <input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password" class="secure-input">
  <button class="btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p id="userInfo"></p>
  <span id="adminBadge" class="badge badge-admin hidden">ğŸ‘‘ Ù…Ø´Ø±Ù</span>
</div>

<div id="adminPanel" class="box hidden">
  <div style="display:flex; justify-content:space-between; align-items:center">
    <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <button class="btn-danger" onclick="logout()" style="width:auto; padding:8px 16px">Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="admin-section">
    <h3>âš½ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
    <input id="matchRound" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">
    <input id="matchName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ø§ØªØ­Ø§Ø¯ vs Ø§Ù„Ù‡Ù„Ø§Ù„)">
    <input id="matchTime" type="datetime-local">
    <button class="btn-info" onclick="addMatch()">â• Ø¥Ø¶Ø§ÙØ©</button>
    <div id="matchesList" style="margin-top:10px; max-height:200px; overflow-y:auto"></div>
  </div>

  <div class="admin-section">
    <h3>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</h3>
    <input id="editRoundId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: round_25)">
    <input id="editRoundName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <div style="display:flex; gap:10px">
      <button class="btn-warning" onclick="editRound()" style="flex:1">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn-danger" onclick="deleteRound()" style="flex:1">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
  </div>

  <div class="admin-section">
    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <input id="userEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <select id="userRole">
      <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
      <option value="admin">Ù…Ø´Ø±Ù</option>
    </select>
    <div style="display:flex; gap:10px">
      <button class="btn-info" onclick="addUser()" style="flex:1">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn-danger" onclick="removeUser()" style="flex:1">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
    <div id="usersList" style="margin-top:10px; max-height:150px; overflow-y:auto"></div>
  </div>

  <div class="admin-section">
    <h3>ğŸ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
    <input id="adminRound" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">
    <div id="adminMatchesContainer"></div>
    <button class="btn-warning" onclick="postResults()">Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ + Ù‚ÙÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
  </div>
</div>

<div id="userPanel" class="box hidden">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2 style="margin:0">ğŸ‘¤ ØªÙˆÙ‚Ø¹Ø§ØªÙŠ</h2>
    <div>
      <span class="badge badge-user">Ù…Ø³ØªØ®Ø¯Ù…</span>
      <button class="btn-danger" onclick="logout()" style="width:auto; padding:6px 12px; font-size:12px">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <input id="roundNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©" type="number">

  <div style="margin:15px 0; padding:10px; background:#e3f2fd; border-radius:8px">
    <label><strong>ğŸ¯ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</strong></label>
    <select id="doubleMatch"><option value="0">Ø¨Ø¯ÙˆÙ† Ù…Ø¶Ø§Ø¹ÙØ©</option></select>
    <small style="color:#666; display:block; margin-top:5px">Ø§Ø®ØªØ± Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¶Ø¹Ù Ø§Ù„Ù†Ù‚Ø§Ø· (6 Ù†Ù‚Ø§Ø·)</small>
  </div>

  <div id="matchesContainer"></div>
  <button class="btn-primary" onclick="submitUserPrediction()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹</button>
</div>

<div class="box">
  <h2>ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
  <button class="btn-info" onclick="loadLeaderboard()" style="margin-bottom:10px">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <div id="leaderboardContainer" style="max-height:400px; overflow-y:auto"></div>
</div>

<script>
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key))) e.preventDefault();
  });
  window.addEventListener('error', e => {
    console.error('Unhandled error:', e.error || e.message, e);
    // Ensure loading spinner hidden on unexpected errors
    const ld = document.getElementById('loading');
    if (ld) ld.classList.add('hidden');
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, writeBatch, increment, query, orderBy, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQw9E_LtJ5QQDGpkGV6n9-re3CD7DLvbk",
    authDomain: "englishleagueapp-6337c.firebaseapp.com",
    projectId: "englishleagueapp-6337c",
    storageBucket: "englishleagueapp-6337c.firebasestorage.app",
    messagingSenderId: "441958380116",
    appId: "1:441958380116:web:741712fe2ca9471e81f3c1",
    measurementId: "G-ETQNFJQBN2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Helper UI
  const show = (id) => document.getElementById(id)?.classList.remove("hidden");
  const hide = (id) => document.getElementById(id)?.classList.add("hidden");

  // Generate match inputs and doubleMatch options
  function createMatchInputs(containerId, prefix) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const div = document.createElement('div');
      div.className = 'match-row';
      div.innerHTML = `<label>Ù…${i}</label>
        <input id="${prefix}${i}h" placeholder="0" type="number" min="0" max="20">
        <input id="${prefix}${i}a" placeholder="0" type="number" min="0" max="20">`;
      container.appendChild(div);
    }
  }
  createMatchInputs('matchesContainer', 'm');
  createMatchInputs('adminMatchesContainer', 'a');

  // populate doubleMatch select
  const doubleSelect = document.getElementById('doubleMatch');
  for (let i = 1; i <= 10; i++) {
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = `Ù…Ø¨Ø§Ø±Ø§Ø© ${i}`;
    doubleSelect.appendChild(opt);
  }

  // auth ready helper
  function authStateReady() {
    return new Promise(resolve => {
      const unsub = onAuthStateChanged(auth, user => {
        unsub();
        resolve(user);
      });
    });
  }

  async function checkIfAdmin(uid) {
    try {
      const snap = await getDoc(doc(db, "admins", uid));
      return snap.exists() && snap.data().role === "admin";
    } catch (e) {
      console.error("checkIfAdmin error:", e);
      return false;
    }
  }

  // Main init
  async function initApp() {
    try {
      // enable persistence but don't block app if it fails
      try {
        await setPersistence(auth, browserLocalPersistence);
        await enableIndexedDbPersistence(db);
      } catch (e) {
        console.warn("Persistence not enabled:", e);
      }

      show("loading");
      hide("loginPage"); hide("adminPanel"); hide("userPanel");

      const user = await authStateReady();
      let isAdmin = false;
      if (user) {
        isAdmin = await checkIfAdmin(user.uid);
      }

      // Always hide loading (even on error) to avoid stuck spinner
      hide("loading");

      if (isAdmin) {
        show("adminPanel");
        document.getElementById("adminBadge")?.classList.remove("hidden");
        await loadMatches(); await loadUsers();
      } else if (user) {
        show("userPanel");
        document.getElementById("adminBadge")?.classList.add("hidden");
      } else {
        show("loginPage");
        document.getElementById("userInfo").innerText = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
      }

      await loadLeaderboard();
    } catch (err) {
      console.error("initApp error:", err);
      hide("loading");
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: " + (err.message || err));
    }
  }

  // Auth
  window.login = async () => {
    try {
      const emailEl = document.getElementById('email');
      const passEl = document.getElementById('password');
      await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      await initApp();
    } catch (e) {
      console.error("login error:", e);
      alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
    }
  };
  window.logout = async () => { await signOut(auth); location.reload(); };

  // Admin functions
  window.addMatch = async () => {
    try {
      const round = document.getElementById('matchRound').value;
      const name = document.getElementById('matchName').value;
      const time = document.getElementById('matchTime').value;
      if (!round || !name) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      await addDoc(collection(db, "matches"), { round, name, time, created_at: new Date().toISOString() });
      alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
      await loadMatches();
    } catch (e) { console.error(e); alert('Ø®Ø·Ø£: ' + e.message); }
  };

  window.editRound = async () => {
    try {
      const id = document.getElementById('editRoundId').value;
      const name = document.getElementById('editRoundName').value;
      if (!id) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬ÙˆÙ„Ø©');
      await updateDoc(doc(db, "rounds", id), { name });
      alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    } catch (e) { console.error(e); alert('Ø®Ø·Ø£: ' + e.message); }
  };

  window.deleteRound = async () => {
    try {
      const id = document.getElementById('editRoundId').value;
      if (!id) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬ÙˆÙ„Ø©');
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      await deleteDoc(doc(db, "rounds", id));
      alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
    } catch (e) { console.error(e); alert('Ø®Ø·Ø£: ' + e.message); }
  };

  window.addUser = async () => {
    try {
      const email = document.getElementById('userEmail').value;
      const role = document.getElementById('userRole').value;
      if (!email) return alert('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      await setDoc(doc(db, "admins", email), { email, role });
      alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
      await loadUsers();
    } catch (e) { console.error(e); alert('Ø®Ø·Ø£: ' + e.message); }
  };

  window.removeUser = async () => {
    try {
      const email = document.getElementById('userEmail').value;
      if (!email) return alert('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      await deleteDoc(doc(db, "admins", email));
      alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
      await loadUsers();
    } catch (e) { console.error(e); alert('Ø®Ø·Ø£: ' + e.message); }
  };

  // Loaders
  async function loadMatches() {
    try {
      const snap = await getDocs(collection(db, "matches"));
      let html = '';
      snap.forEach(d => { const o = d.data(); html += `<div style="padding:8px; border-bottom:1px solid #eee">${o.name} - ${o.round}</div>`; });
      document.getElementById("matchesList").innerHTML = html || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª';
    } catch (e) { console.error('loadMatches', e); }
  }
  async function loadUsers() {
    try {
      const snap = await getDocs(collection(db, "admins"));
      let html = '';
      snap.forEach(d => { const o = d.data(); html += `<div style="padding:8px; border-bottom:1px solid #eee">${o.email} - ${o.role}</div>`; });
      document.getElementById("usersList").innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†';
    } catch (e) { console.error('loadUsers', e); }
  }

  // post results
  window.postResults = async () => {
    try {
      const roundNum = document.getElementById('adminRound').value;
      if (!roundNum) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©');
      const round = "round_" + roundNum;
      const actualResult = {};
      for (let i = 1; i <= 10; i++) {
        actualResult[`match_${i}_home`] = Number(document.getElementById(`a${i}h`).value) || 0;
        actualResult[`match_${i}_away`] = Number(document.getElementById(`a${i}a`).value) || 0;
      }
      await setDoc(doc(db, "actual_results", round), actualResult, { merge: true });
      await setDoc(doc(db, "rounds", round), { is_locked: true }, { merge: true });

      const predsSnap = await getDocs(collection(db, "predictions", round, "users"));
      const batch = writeBatch(db);
      predsSnap.forEach(p => {
        const d = p.data();
        let pts = 0;
        for (let i = 1; i <= 10; i++) {
          if (d[`match_${i}_home`] === actualResult[`match_${i}_home`] && d[`match_${i}_away`] === actualResult[`match_${i}_away`]) {
            pts += 3;
            if (d.double_match === i) pts += 3;
          }
        }
        batch.update(p.ref, { total_points: pts, updated_at: new Date().toISOString() });
        batch.set(doc(db, "leaderboard", p.id), { participant_name: d.participant_name || '', total_points: increment(pts), updated_at: new Date().toISOString() }, { merge: true });
      });
      await batch.commit();
      alert("ğŸ† ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·!");
      await loadLeaderboard();
    } catch (e) { console.error('postResults', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ' + e.message); }
  };

  // submit prediction
  window.submitUserPrediction = async () => {
    try {
      const user = auth.currentUser;
      if (!user) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      // check locked
      const roundNum = document.getElementById('roundNumber').value;
      if (!roundNum) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©');
      const round = "round_" + roundNum;
      const roundSnap = await getDoc(doc(db, "rounds", round));
      if (roundSnap.exists() && roundSnap.data().is_locked) return alert('âŒ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù…Ù‚ÙÙ„Ø©!');

      const prediction = { participant_name: user.email || user.uid, total_points: 0, double_match: Number(document.getElementById('doubleMatch').value), timestamp: new Date().toISOString() };
      for (let i = 1; i <= 10; i++) {
        prediction[`match_${i}_home`] = Number(document.getElementById(`m${i}h`).value) || 0;
        prediction[`match_${i}_away`] = Number(document.getElementById(`m${i}a`).value) || 0;
      }
      await setDoc(doc(db, "predictions", round, "users", user.uid), prediction, { merge: true });
      alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    } catch (e) { console.error('submitUserPrediction', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + e.message); }
  };

  // leaderboard
  async function loadLeaderboard() {
    try {
      const q = query(collection(db, "leaderboard"), orderBy("total_points", "desc"), limit(20));
      const snap = await getDocs(q);
      let html = `<table class="leaderboard"><tr><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>`;
      let rank = 1;
      snap.forEach(s => {
        const d = s.data();
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        html += `<tr class="${rankClass}"><td>${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank}</td><td>${d.participant_name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td><td>${d.total_points || 0}</td></tr>`;
        rank++;
      });
      html += '</table>';
      document.getElementById("leaderboardContainer").innerHTML = html;
    } catch (e) { console.error('loadLeaderboard', e); document.getElementById("leaderboardContainer").innerText = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†'; }
  }

  // start
  document.addEventListener("DOMContentLoaded", initApp);
</script>

</body>
</html>