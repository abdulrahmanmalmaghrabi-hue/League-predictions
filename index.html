<script type="module">
/* ===============================
   Firebase imports
================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
  collection, addDoc, getDocs, writeBatch, increment,
  query, orderBy, limit, enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===============================
   Firebase config
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyAQw9E_LtJ5QQDGpkGV6n9-re3CD7DLvbk",
  authDomain: "englishleagueapp-6337c.firebaseapp.com",
  projectId: "englishleagueapp-6337c",
  storageBucket: "englishleagueapp-6337c.firebasestorage.app",
  messagingSenderId: "441958380116",
  appId: "1:441958380116:web:741712fe2ca9471e81f3c1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===============================
   Persistence
================================ */
try {
  await setPersistence(auth, browserLocalPersistence);
  await enableIndexedDbPersistence(db);
} catch (e) {
  console.log("Persistence error:", e);
}

/* ===============================
   Global state
================================ */
let currentUser = null;
let isAdmin = false;

/* ===============================
   Helpers
================================ */
const show = id => document.getElementById(id).classList.remove("hidden");
const hide = id => document.getElementById(id).classList.add("hidden");

/* ===============================
   Auth helpers
================================ */
function authStateReady() {
  return new Promise(resolve => {
    const unsub = onAuthStateChanged(auth, user => {
      unsub();
      resolve(user);
    });
  });
}

async function checkIfAdmin(uid) {
  const snap = await getDoc(doc(db, "admins", uid));
  return snap.exists() && snap.data().role === "admin";
}

/* ===============================
   Create match inputs
================================ */
function createMatchInputs(containerId, prefix) {
  const c = document.getElementById(containerId);
  c.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    c.innerHTML += `
      <div class="match-row">
        <label>Ù…${i}</label>
        <input id="${prefix}${i}h" type="number" min="0">
        <input id="${prefix}${i}a" type="number" min="0">
      </div>`;
  }
}
createMatchInputs("matchesContainer", "m");
createMatchInputs("adminMatchesContainer", "a");

/* ===============================
   Init app
================================ */
async function initApp() {
  show("loading");
  hide("loginPage");
  hide("adminPanel");
  hide("userPanel");

  const user = await authStateReady();
  hide("loading");

  if (!user) {
    show("loginPage");
    return;
  }

  currentUser = user;
  isAdmin = await checkIfAdmin(user.uid);

  if (isAdmin) {
    show("adminPanel");
    await loadMatches();
    await loadUsers();
  } else {
    show("userPanel");
  }

  await loadLeaderboard();
}

/* ===============================
   AUTH FUNCTIONS
================================ */
async function login() {
  await signInWithEmailAndPassword(auth, email.value, password.value);
  await initApp();
}

async function logout() {
  await signOut(auth);
  location.reload();
}

/* ===============================
   ADMIN FUNCTIONS
================================ */
async function addMatch() {
  await addDoc(collection(db, "matches"), {
    round: matchRound.value,
    name: matchName.value,
    time: matchTime.value
  });
  alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  loadMatches();
}

async function editRound() {
  await updateDoc(doc(db, "rounds", editRoundId.value), {
    name: editRoundName.value
  });
  alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
}

async function deleteRound() {
  if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) return;
  await deleteDoc(doc(db, "rounds", editRoundId.value));
  alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
}

async function addUser() {
  await setDoc(doc(db, "admins", userEmail.value), {
    email: userEmail.value,
    role: userRole.value
  });
  loadUsers();
}

async function removeUser() {
  await deleteDoc(doc(db, "admins", userEmail.value));
  loadUsers();
}

/* ===============================
   LOAD DATA
================================ */
async function loadMatches() {
  const snap = await getDocs(collection(db, "matches"));
  matchesList.innerHTML = snap.docs.map(d =>
    `<div>${d.data().name}</div>`
  ).join("") || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
}

async function loadUsers() {
  const snap = await getDocs(collection(db, "admins"));
  usersList.innerHTML = snap.docs.map(d =>
    `<div>${d.data().email}</div>`
  ).join("") || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
}

/* ===============================
   USER PREDICTION
================================ */
async function submitUserPrediction() {
  const round = "round_" + roundNumber.value;
  const data = {
    participant_name: currentUser.email,
    double_match: Number(doubleMatch.value),
    total_points: 0
  };

  for (let i = 1; i <= 10; i++) {
    data[`match_${i}_home`] = Number(document.getElementById(`m${i}h`).value) || 0;
    data[`match_${i}_away`] = Number(document.getElementById(`m${i}a`).value) || 0;
  }

  await setDoc(
    doc(db, "predictions", round, "users", currentUser.uid),
    data
  );

  alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
}

/* ===============================
   LEADERBOARD
================================ */
async function loadLeaderboard() {
  const q = query(
    collection(db, "leaderboard"),
    orderBy("total_points", "desc"),
    limit(20)
  );
  const snap = await getDocs(q);

  let html = `<table class="leaderboard">
    <tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>`;

  let r = 1;
  snap.forEach(d => {
    html += `<tr>
      <td>${r++}</td>
      <td>${d.data().participant_name}</td>
      <td>${d.data().total_points}</td>
    </tr>`;
  });

  html += "</table>";
  leaderboardContainer.innerHTML = html;
}

/* ===============================
   EXPORT TO WINDOW ðŸ”‘
================================ */
Object.assign(window, {
  login,
  logout,
  addMatch,
  editRound,
  deleteRound,
  addUser,
  removeUser,
  submitUserPrediction,
  loadLeaderboard
});

/* ===============================
   START
================================ */
document.addEventListener("DOMContentLoaded", initApp);
</script>